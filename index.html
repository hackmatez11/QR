<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Medical Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
  <div id="app"></div>

  <script>
    // ============================================
    // CONFIGURATION - UPDATE THESE VALUES
    // ============================================
    const SUPABASE_URL = 'https://edwuptavjdakjuqyrxaf.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_cHYdCX_v8CTBV0VlqaaAwQ_GR-17x_Y';
    // ============================================

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Get patient ID from URL
    function getPatientId() {
      const urlParams = new URLSearchParams(window.location.search);
      const queryId = urlParams.get('id');
      
      const pathParts = window.location.pathname.split('/');
      const pathId = pathParts[pathParts.length - 1].replace('.html', '');
      
      return queryId || (pathId !== 'patient-profile' ? pathId : null);
    }

    // Loading state
    function showLoading() {
      document.getElementById('app').innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading patient data...</p>
          </div>
        </div>
      `;
    }

    // Error state
    function showError(message) {
      document.getElementById('app').innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Data Not Found</h2>
            <p class="text-gray-600">${message}</p>
          </div>
        </div>
      `;
    }

    // Info card component
    function InfoCard(icon, label, value, urgent = false) {
      const bgClass = urgent ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200';
      const iconBgClass = urgent ? 'bg-red-100' : 'bg-blue-100';
      const iconColorClass = urgent ? 'text-red-600' : 'text-blue-600';
      
      return `
        <div class="${bgClass} p-4 rounded-xl border-2">
          <div class="flex items-start gap-3">
            <div class="${iconBgClass} p-2 rounded-lg">
              ${icon}
            </div>
            <div class="flex-1">
              <p class="text-sm text-gray-500 mb-1">${label}</p>
              <p class="font-semibold text-gray-800">${value || 'Not specified'}</p>
            </div>
          </div>
        </div>
      `;
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / (1024 * 1024)).toFixed(1) + " MB";
    }

    // Get file icon
    function getFileIcon(fileType) {
      if (fileType.startsWith('image/')) {
        return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>';
      }
      return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>';
    }

    // Get category label
    function getCategoryLabel(category) {
      const categories = {
        photo: 'Photo',
        report: 'Lab Report',
        prescription: 'Prescription',
        xray: 'X-Ray',
        mri: 'MRI/CT Scan',
        other: 'Other'
      };
      return categories[category] || category;
    }

    // Render documents section
    function renderDocuments(documents) {
      if (!documents || documents.length === 0) {
        return `
          <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Medical Documents
            </h2>
            <div class="text-center py-8 text-gray-500">
              <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p>No documents uploaded yet</p>
            </div>
          </div>
        `;
      }

      const documentCards = documents.map(doc => {
        const isImage = doc.file_type.startsWith('image/');
        return `
          <div class="bg-white border-2 border-gray-200 rounded-xl p-4 hover:shadow-lg transition-shadow fade-in">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3 flex-1 min-w-0">
                <div class="p-2 bg-blue-100 rounded-lg flex-shrink-0">
                  ${getFileIcon(doc.file_type)}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-medium text-gray-800 truncate">${doc.file_name}</p>
                  <p class="text-xs text-gray-500">${formatFileSize(doc.file_size)}</p>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-2 mb-3">
              <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full font-medium">
                ${getCategoryLabel(doc.category)}
              </span>
              <span class="text-xs text-gray-500">
                ${new Date(doc.uploaded_at).toLocaleDateString()}
              </span>
            </div>

            ${isImage ? `
              <img src="${doc.file_url}" alt="${doc.file_name}" 
                   class="w-full h-32 object-cover rounded-lg mb-3 cursor-pointer hover:opacity-90 transition-opacity"
                   onclick="window.open('${doc.file_url}', '_blank')">
            ` : ''}

            <div class="flex gap-2">
              <button onclick="window.open('${doc.file_url}', '_blank')"
                      class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center justify-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                View
              </button>
              <button onclick="downloadFile('${doc.file_url}', '${doc.file_name}')"
                      class="flex-1 px-3 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium flex items-center justify-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Download
              </button>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Medical Documents (${documents.length})
          </h2>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${documentCards}
          </div>
        </div>
      `;
    }

    // Download file function
    window.downloadFile = function(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    };

    // Icons
    const icons = {
      user: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>',
      phone: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>',
      droplet: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>',
      activity: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>',
      heart: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>',
      alert: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
      pill: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
      file: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
    };

    // Render patient data
    function renderPatient(data, documents) {
      document.getElementById('app').innerHTML = `
        <div class="py-8 px-4">
          <div class="max-w-4xl mx-auto">
            
            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
              <div class="flex items-center gap-4 mb-4">
                <div class="p-4 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl">
                  <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                </div>
                <div>
                  <h1 class="text-3xl font-bold text-gray-800">
                    ${data.full_name || 'Patient'}'s Medical Profile
                  </h1>
                  <p class="text-gray-500">Complete Medical Information</p>
                </div>
              </div>
            </div>

            <!-- Basic Information -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
              <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Basic Information
              </h2>
              <div class="grid md:grid-cols-2 gap-4">
                ${InfoCard(icons.user, 'Date of Birth', data.dob)}
                ${InfoCard(icons.user, 'Gender', data.gender)}
                ${InfoCard(icons.droplet, 'Blood Group', data.blood_group, true)}
                ${InfoCard(icons.phone, 'Phone', data.phone)}
                ${InfoCard(icons.phone, 'Emergency Contact', data.emergency_contact, true)}
                ${InfoCard(icons.activity, 'Height', data.height ? `${data.height} cm` : null)}
                ${InfoCard(icons.activity, 'Weight', data.weight ? `${data.weight} kg` : null)}
              </div>
            </div>

            <!-- Medical History -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
              <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                Medical History
              </h2>
              <div class="space-y-4">
                ${data.diseases ? `
                  <div class="p-4 bg-red-50 rounded-xl border-2 border-red-200">
                    <div class="flex items-start gap-3">
                      ${icons.alert.replace('w-5 h-5', 'w-5 h-5 text-red-600 mt-1')}
                      <div>
                        <p class="font-semibold text-red-800 mb-1">Known Diseases</p>
                        <p class="text-red-700">${data.diseases}</p>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                ${data.allergies ? `
                  <div class="p-4 bg-orange-50 rounded-xl border-2 border-orange-200">
                    <div class="flex items-start gap-3">
                      ${icons.alert.replace('w-5 h-5', 'w-5 h-5 text-orange-600 mt-1')}
                      <div>
                        <p class="font-semibold text-orange-800 mb-1">Allergies</p>
                        <p class="text-orange-700">${data.allergies}</p>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                ${data.medications ? `
                  <div class="p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
                    <div class="flex items-start gap-3">
                      ${icons.pill.replace('w-5 h-5', 'w-5 h-5 text-blue-600 mt-1')}
                      <div>
                        <p class="font-semibold text-blue-800 mb-1">Current Medications</p>
                        <p class="text-blue-700">${data.medications}</p>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                ${data.surgeries ? `
                  <div class="p-4 bg-purple-50 rounded-xl border-2 border-purple-200">
                    <div class="flex items-start gap-3">
                      ${icons.file.replace('w-5 h-5', 'w-5 h-5 text-purple-600 mt-1')}
                      <div>
                        <p class="font-semibold text-purple-800 mb-1">Past Surgeries</p>
                        <p class="text-purple-700">${data.surgeries}</p>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                ${data.lifestyle ? `
                  <div class="p-4 bg-green-50 rounded-xl border-2 border-green-200">
                    <div class="flex items-start gap-3">
                      ${icons.activity.replace('w-5 h-5', 'w-5 h-5 text-green-600 mt-1')}
                      <div>
                        <p class="font-semibold text-green-800 mb-1">Lifestyle</p>
                        <p class="text-green-700">${data.lifestyle}</p>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                ${data.notes ? `
                  <div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200">
                    <div class="flex items-start gap-3">
                      ${icons.file.replace('w-5 h-5', 'w-5 h-5 text-gray-600 mt-1')}
                      <div>
                        <p class="font-semibold text-gray-800 mb-1">Additional Notes</p>
                        <p class="text-gray-700">${data.notes}</p>
                      </div>
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>

            <!-- Medical Documents -->
            ${renderDocuments(documents)}

            <!-- Footer -->
            <div class="text-center text-gray-500 text-sm">
              <p>This medical information is confidential and should only be accessed by authorized medical personnel.</p>
            </div>

          </div>
        </div>
      `;
    }

    // Main function
    async function loadPatientData() {
      showLoading();

      const patientId = getPatientId();
      
      if (!patientId) {
        showError('No patient ID provided in URL');
        return;
      }

      console.log('Loading data for patient ID:', patientId);

      try {
        // Fetch patient data
        const { data: patientData, error: patientError } = await supabaseClient
          .from('patients')
          .select('*')
          .eq('id', patientId)
          .single();

        if (patientError) {
          console.error('Patient error:', patientError);
          throw patientError;
        }
        
        if (!patientData) {
          showError('Patient data not found');
          return;
        }

        console.log('Patient data loaded:', patientData);

        // Fetch patient documents
        const { data: documents, error: docsError } = await supabaseClient
          .from('patient_documents')
          .select('*')
          .eq('patient_id', patientId)
          .order('uploaded_at', { ascending: false });

        console.log('Documents query result:', { documents, docsError });

        if (docsError) {
          console.error('Error fetching documents:', docsError);
        }

        renderPatient(patientData, documents || []);
      } catch (err) {
        console.error('Error:', err);
        showError('Failed to load patient data. Please check your configuration.');
      }
    }

    // Load data when page loads
    loadPatientData();
  </script>
</body>
</html>